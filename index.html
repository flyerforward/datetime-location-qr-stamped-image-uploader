<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2980b9" />
<title>Flyer Forward Stamped Photo Generator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  * { box-sizing: border-box; }
  body {
    margin:0;
    background:#f5f7fa;
    font-family:'Inter',sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:2rem 1rem 3rem;
    color:#333;
    min-height:100vh;
  }
  h1 {
    font-weight:600;
    margin-bottom:.1rem;
    text-align:center;
    color:#2c3e50;
  }
  .camera-container {
    position:relative;
    width:100%;
    max-width:320px;
  }
  video {
    border-radius:16px;
    box-shadow:0 8px 24px rgba(44,62,80,0.15);
    width:100%;
    aspect-ratio:3/4;
    object-fit:cover;
    background:#000;
  }
  .flash {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:white;
    opacity:0;
    border-radius:16px;
    pointer-events:none;
    transition:opacity 0.3s ease;
  }
  .button-canvas-wrapper {
    margin-top:1.8rem;
    width:100%;
    max-width:320px;
    display:flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  .button-row {
    display:flex;
    gap:2rem;
    justify-content:center;
    width: 100%;
  }
  button.icon-btn {
    background:#2980b9;
    border:none;
    cursor:pointer;
    border-radius:50%;
    width:72px;
    height:72px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 4px 12px rgba(41,128,185,0.4);
    transition:background-color 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
    touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
  }
  button.icon-btn:disabled {
    background:#7f8c8d;
    cursor:not-allowed;
    box-shadow:none;
    opacity:0.5;
  }
  button.icon-btn:hover:not(:disabled) {
    background:#1c5980;
    box-shadow:0 6px 16px rgba(28,89,128,0.6);
  }
  button.icon-btn:active:not(:disabled) {
    background:#174663;
  }
  button.icon-btn svg {
    width:32px;
    height:32px;
    pointer-events:none;
  }
  .spinner {
    border:3px solid rgba(255,255,255,0.3);
    border-top:3px solid white;
    border-radius:50%;
    width:28px;
    height:28px;
    animation:spin 1s linear infinite;
    pointer-events:none;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }
  canvas {
    border-radius:16px;
    box-shadow:0 8px 24px rgba(44,62,80,0.15);
    width:100%;
    max-width:320px;
    display:none;
    aspect-ratio:3/4;
    object-fit:cover;
  }
  /* ✅ Fixed Checkmark Alignment */
  .checkmark {
    width:28px;
    height:28px;
    border-radius:50%;
    border:2px solid white;
    display:flex;
    align-items:center;
    justify-content:center;
    transform:scale(0);
    animation:popIn 0.3s forwards;
  }
  .checkmark:after {
    content:'';
    width:7px;
    height:14px;
    border:solid white;
    border-width:0 2px 2px 0;
    transform:rotate(45deg);
  }
  @keyframes popIn {
    to { transform:scale(1); }
  }
  @media(max-width:480px){
    button.icon-btn{width:64px;height:64px;}
    button.icon-btn svg{width:28px;height:28px;}
    .camera-container {max-width:280px;}
    .button-canvas-wrapper {max-width:280px;}
    canvas {max-width:280px;width:100%;}
  }
</style>
</head>
<body>
  
<img src="icon-512.png" alt="Flyer Forward Stamped Photo Generator Icon" style="width:128px;height:128px;display:block;margin:0 auto .5rem auto;border-radius:24px;">

<div class="camera-container">
  <video id="video" autoplay playsinline></video>
  <div id="flashOverlay" class="flash"></div>
</div>

<div class="button-canvas-wrapper">
  <div class="button-row">
    <!-- Snap Button -->
    <button id="snapBtn" class="icon-btn" title="Snap Photo">
      <!-- ✅ NEW Camera SVG -->
      <svg id="cameraIcon" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
        <g>
          <path fill="white" d="M60,10H49.656l-6.828-6.828C42.078,2.422,41.062,2,40,2H24c-1.062,0-2.078,0.422-2.828,1.172L14.344,10H4
            c-2.211,0-4,1.789-4,4v44c0,2.211,1.789,4,4,4h56c2.211,0,4-1.789,4-4V14C64,11.789,62.211,10,60,10z M32,50
            c-8.836,0-16-7.164-16-16s7.164-16,16-16s16,7.164,16,16S40.836,50,32,50z"/>
          <circle fill="white" cx="32" cy="34" r="8"/>
        </g>
      </svg>
    </button>

    <!-- Download Button -->
    <button id="downloadBtn" class="icon-btn" title="Download Photo" style="display:none;" disabled>
      <svg id="downloadIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
        <path stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 15v2a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-2m-8 1V4m0 12-4-4m4 4 4-4"/>
      </svg>
    </button>
  </div>

  <canvas id="canvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const snapBtn=document.getElementById("snapBtn");
const cameraIcon=document.getElementById("cameraIcon");
const downloadBtn=document.getElementById("downloadBtn");
const downloadIcon=document.getElementById("downloadIcon");
const flashOverlay=document.getElementById("flashOverlay");
const ctx=canvas.getContext("2d");

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
    video.srcObject=stream;
  }catch(e){alert("Could not access camera: "+e);}
}

function getPosition(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject("Geolocation not supported");
    navigator.geolocation.getCurrentPosition(
      pos=>resolve(pos.coords),
      err=>reject(err.message),
      {enableHighAccuracy:true,timeout:10000}
    );
  });
}

async function drawQRCode(data,x,y,size){
  return new Promise((resolve,reject)=>{
    QRCode.toCanvas(data,{errorCorrectionLevel:'H',width:size},(err,qrCanvas)=>{
      if(err) reject(err);
      ctx.drawImage(qrCanvas,x,y);
      resolve();
    });
  });
}

function triggerFlash(){
  flashOverlay.style.opacity="1";
  setTimeout(()=>flashOverlay.style.opacity="0",150);
}

function showSpinner(){
  cameraIcon.style.display="none";
  const spinner=document.createElement("div");
  spinner.className="spinner";
  spinner.id="loadingSpinner";
  snapBtn.appendChild(spinner);
}

function hideSpinner(){
  const spinner=document.getElementById("loadingSpinner");
  if(spinner) spinner.remove();
  cameraIcon.style.display="block";
}

snapBtn.addEventListener("click",async()=>{
  snapBtn.disabled=true;
  showSpinner();
  downloadBtn.style.display="none";
  downloadBtn.disabled=true;
  canvas.style.display="none";
  triggerFlash();

  try{
    const width=video.videoWidth;
    const height=video.videoHeight;
    canvas.width=width;
    canvas.height=height;
    ctx.drawImage(video,0,0,width,height);

    let coordsText="GPS unavailable";
    let coords=null;
    try{
      coords=await getPosition();
      coordsText=`Lat:${coords.latitude.toFixed(6)}, Lon:${coords.longitude.toFixed(6)}`;
    }catch(e){console.warn("GPS error:",e);}

    const now=new Date();
    const qrData=JSON.stringify({timestamp:now.toISOString(),latitude:coords?coords.latitude:null,longitude:coords?coords.longitude:null});

    const qrSize=width*0.25;
    await drawQRCode(qrData,10,10,qrSize);

    ctx.font=`${qrSize/7}px monospace`;
    ctx.fillStyle="white";
    ctx.strokeStyle="black";
    ctx.lineWidth=2;
    const lines=[`${now.toLocaleString()}`,coordsText];
    const lineHeight=qrSize/7+4;
    let textY=height-10;
    for(let i=lines.length-1;i>=0;i--){
      const textWidth=ctx.measureText(lines[i]).width;
      const textX=(width-textWidth)/2;
      ctx.strokeText(lines[i],textX,textY);
      ctx.fillText(lines[i],textX,textY);
      textY-=lineHeight;
    }

    canvas.style.display="block";
    downloadBtn.style.display="inline-flex";
    downloadBtn.disabled=false;
  }catch(err){alert("Error capturing photo: "+err);}
  finally{
    hideSpinner();
    snapBtn.disabled=false;
  }
});

downloadBtn.addEventListener("click",()=>{
  if(downloadBtn.disabled) return;

  // ✅ Trigger Download Programmatically
  const maxW=900;
  let tempCanvas=canvas;
  if(canvas.width>maxW){
    const scale=maxW/canvas.width;
    tempCanvas=document.createElement("canvas");
    tempCanvas.width=maxW;
    tempCanvas.height=canvas.height*scale;
    tempCanvas.getContext("2d").drawImage(canvas,0,0,tempCanvas.width,tempCanvas.height);
  }

  const link=document.createElement("a");
  link.download=`photo_${new Date().toISOString()}.jpg`;
  link.href=tempCanvas.toDataURL("image/jpeg",0.4);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // ✅ Animate Green Checkmark
  downloadBtn.style.background="#27ae60";
  downloadIcon.style.display="none";
  const check=document.createElement("div");
  check.className="checkmark";
  downloadBtn.appendChild(check);

  // ✅ Hide Button + Reset for Next Capture
  downloadBtn.disabled=true;
  setTimeout(()=>{
    downloadBtn.style.display="none";
    check.remove();
    downloadBtn.style.background="#2980b9";
    downloadIcon.style.display="block";
    canvas.style.display="none";
    ctx.clearRect(0,0,canvas.width,canvas.height);
  },800);
});

startCamera();
</script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
    .then(()=>console.log('Service Worker Registered'))
    .catch(err=>console.warn('Service Worker registration failed:',err));
}
</script>
</body>
</html>
